syntax = "proto3";

package deathnode.sync;

option java_package = "com.deathnode.common.grpc";
option java_outer_classname = "SyncProto";
option java_multiple_files = true;

// ============================================================================
// Client -> Server Messages
// ============================================================================

/**
 * Simple acknowledgment message.
 */
message Ack {
  bool success = 1;
  string message = 2;
}

/**
 * Error message.
 */
message Error {
  string code = 1;
  string message = 2;
  repeated string details = 3;
}

/**
 * Initial handshake message from client.
 */
message Hello {
  string node_id = 1;
  bool start_sync = 2;  // true if this node wants to initiate a sync round, false if just to connect
}

/**
 * Client uploads its buffered envelopes to the server.
 */
message BufferUpload {
  string node_id = 1;
  
  // Each envelope is the complete JSON bytes of the envelope
  repeated bytes envelopes = 2;

  // Buffer Merkle root (computed over the envelopes)
  bytes buffer_root = 3;
  
  // Signed Merkle root of the buffer envelopes
  bytes signed_buffer_root = 4;
}

/**
 * Client message union.
 */
message ClientMessage {
  oneof body {
    Hello hello = 1;
    BufferUpload buffer_upload = 2;
    Ack ack = 3;
    Error error = 4;
  }
}

// ============================================================================
// Server -> Client Messages
// ============================================================================

/**
 * Server requests buffer from client for a sync round.
 */
message RequestBuffer {
  string round_id = 1;
  string message = 2;  // Human-readable instruction
}

/**
 * Server returns the globally ordered envelopes.
 */
message SyncResult {
  string round_id = 1;
  
  // All envelopes from all nodes, globally ordered
  repeated bytes ordered_envelopes = 2;
  
  int64 block_number = 3;
  
  // Placeholder for future: server-signed block commitment
  bytes block_root = 4;
  
  bytes signed_block_root = 5;
  
  // Placeholder for future: per-node signed buffer roots
  repeated SignedBufferRoot per_node_signed_buffer_roots = 6;
  
  // Reference to previous block (for chaining)
  bytes prev_block_root = 7;
}

/**
 * Placeholder for future: represents a node's signed buffer commitment.
 */
message SignedBufferRoot {
  string node_id = 1;
  bytes buffer_root = 2;
  bytes signed_buffer_root = 3;
}

/**
 * Server message union.
 */
message ServerMessage {
  oneof body {
    RequestBuffer request_buffer = 1;
    SyncResult sync_result = 2;
    Ack ack = 3;
    Error error = 4;
  }
}

// ============================================================================
// Service Definition
// ============================================================================

/**
 * Bidirectional streaming RPC for synchronization.
 */
service SyncService {
  rpc Sync(stream ClientMessage) returns (stream ServerMessage);
}